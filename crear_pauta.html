<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>PAUTA PREVENTIVA DE SISTEMAS CRÍTICOS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --color-primary: #2c5282;
      --color-secondary: #ebf8ff;
      --color-accent: #2b6cb0;
      --color-success: #38a169;
      --color-error: #e53e3e;
      --color-warning: #dd6b20;
      --color-text: #2d3748;
      --color-light: #f7fafc;
      --border-radius: 10px;
      --box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #3f72af, #dbe2ef);
      font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: start;
      min-height: 100vh;
      padding: 20px;
      color: var(--color-text);
      line-height: 1.6;
    }

    .app-container {
      max-width: 1400px;
      width: 100%;
      margin: 0 auto;
    }

    /* Botón Volver */
    .btn-volver {
      position: fixed;
      top: 20px;
      left: 20px;
      background-color: var(--color-primary);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      padding: 10px 20px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 1000;
      box-shadow: var(--box-shadow);
      transition: var(--transition);
    }

    .btn-volver:hover {
      background-color: #1a365d;
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }

    @media (max-width: 768px) {
      .btn-volver {
        position: relative;
        top: 0;
        left: 0;
        margin-bottom: 15px;
        width: 100%;
        justify-content: center;
      }
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: var(--color-primary);
      border-radius: var(--border-radius);
      color: white;
      box-shadow: var(--box-shadow);
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }

    .header h1 {
      font-size: 2.2rem;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .header p {
      opacity: 0.9;
      font-size: 1.1rem;
      margin-bottom: 10px;
    }

    .header-info {
      display: flex;
      justify-content: space-between;
      width: 100%;
      margin-top: 15px;
      font-size: 0.9rem;
      background: rgba(255, 255, 255, 0.1);
      padding: 10px;
      border-radius: 5px;
    }

    .form-container {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      width: 100%;
      padding: 35px;
      margin-bottom: 30px;
      transition: var(--transition);
    }

    .form-container:hover {
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 30px;
      background: var(--color-light);
      padding: 20px;
      border-radius: var(--border-radius);
    }

    @media (max-width: 768px) {
      .info-grid {
        grid-template-columns: 1fr;
      }
    }

    .info-item {
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: 600;
      display: block;
      margin-bottom: 8px;
      color: var(--color-accent);
    }

    .required-field::after {
      content: " *";
      color: var(--color-error);
    }

    input, select, textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e2e8f0;
      border-radius: var(--border-radius);
      font-size: 1rem;
      transition: var(--transition);
      background-color: white;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(44, 82, 130, 0.2);
    }

    .section {
      border: 2px solid var(--color-secondary);
      padding: 20px;
      border-radius: var(--border-radius);
      margin-top: 25px;
      background-color: #f8fbff;
      transition: var(--transition);
    }

    .section:hover {
      border-color: var(--color-primary);
    }

    .section-title {
      color: var(--color-primary);
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 1.3rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 2px solid var(--color-secondary);
      padding-bottom: 10px;
    }

    .section-title i {
      background: var(--color-primary);
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
    }

    .checklist-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .checklist-table th, .checklist-table td {
      padding: 14px 16px;
      border: 1px solid #e2e8f0;
      text-align: left;
      vertical-align: top;
    }

    .checklist-table th {
      background-color: var(--color-primary);
      color: white;
      font-weight: 600;
    }

    .checklist-table tr:nth-child(even) {
      background-color: #f7fafc;
    }

    .checklist-table tr:hover {
      background-color: #ebf8ff;
    }

    .check-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .item-number {
      background-color: var(--color-primary);
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      flex-shrink: 0;
    }

    .item-description {
      flex-grow: 1;
    }

    .circle-checkbox {
      display: flex;
      gap: 20px;
      justify-content: center;
    }

    .circle-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }

    .circle {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 3px solid #cbd5e0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      background-color: white;
      position: relative;
    }

    .circle:hover {
      border-color: var(--color-primary);
      transform: scale(1.1);
    }

    .circle.selected {
      border-color: var(--color-primary);
      background-color: var(--color-primary);
    }

    .circle.selected::after {
      content: "✓";
      color: white;
      font-weight: bold;
      font-size: 1.2rem;
    }

    .circle-label {
      font-size: 0.85rem;
      color: #718096;
      font-weight: 500;
    }

    .torque-visual-container {
      margin: 30px 0;
    }

    .torque-visual-title {
      color: var(--color-primary);
      margin-bottom: 25px;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: center;
    }

    .header-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
      border: 1px solid black;
    }
    
    .header-table td {
      border: 1px solid black;
      padding: 8px;
      text-align: center;
      vertical-align: middle;
    }
    
    .logo-placeholder {
      font-weight: bold;
      color: white;
      font-size: 1.4em;
      background-color: var(--color-primary);
      padding: 5px 10px;
      border-radius: 4px;
    }

    .info-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    
    .info-table td {
      border: 1px solid #d1d5db;
      padding: 10px;
      background-color: #f8f9fa;
    }
    
    .info-table .label {
      font-weight: bold;
      background: #e5e7eb;
      width: 160px;
    }

    .axle-row {
      display: flex;
      gap: 25px;
      margin-top: 10px;
      min-height: 220px;
      margin-bottom: 30px;
    }
    
    .obs-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .obs-container strong {
      margin-bottom: 8px;
      color: var(--color-primary);
    }
    
    .obs-container textarea {
      flex: 1;
      border: 2px solid black;
      resize: none;
      padding: 12px;
      font-family: inherit;
      font-size: 14px;
      border-radius: 5px;
    }
    
    .visual-container {
      flex: 2;
      border: 1px solid #cbd5e0;
      padding: 20px;
      text-align: center;
      position: relative;
      background-color: #f9fafb;
      border-radius: var(--border-radius);
    }
    
    .visual-container strong {
      display: block;
      margin-bottom: 15px;
      font-size: 1.2em;
      color: var(--color-primary);
    }

    .wheels-wrapper {
      display: flex;
      justify-content: space-around;
      align-items: center;
      margin-top: 15px;
    }
    
    .wheel-group {
      text-align: center;
    }
    
    .wheel-group > div {
      margin-bottom: 10px;
      font-weight: bold;
      color: var(--color-text);
    }

    .bolt {
      fill: white;
      stroke: black;
      stroke-width: 1.5;
      cursor: pointer;
      transition: fill 0.2s;
    }
    
    .bolt.marked {
      fill: black;
    }

    .torque-ui {
      display: flex;
      flex-direction: column;
      width: 70px;
    }
    
    .torque-head {
      background: black;
      color: white;
      font-weight: bold;
      padding: 6px 3px;
      font-size: 11px;
      border-radius: 4px 4px 0 0;
    }
    
    .torque-input {
      border: 1px solid #cbd5e0;
      background: #e5e7eb;
      height: 40px;
      text-align: center;
      font-weight: bold;
      font-size: 16px;
      border-radius: 0 0 4px 4px;
    }

    .section-header {
      background: var(--color-primary);
      color: white;
      padding: 10px;
      font-weight: bold;
      text-align: center;
      margin-top: 25px;
      text-transform: uppercase;
      border-radius: var(--border-radius);
    }

    .footer-signatures {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
      padding-top: 15px;
      border-top: 2px solid #d1d5db;
    }

    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: var(--border-radius);
      color: white;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }

    .btn:active {
      transform: translateY(-1px);
    }

    .btn-primary {
      background: var(--color-primary);
    }

    .btn-primary:hover {
      background: #1a365d;
    }

    .btn-secondary {
      background: #4a5568;
    }

    .btn-secondary:hover {
      background: #2d3748;
    }

    .btn-success {
      background: var(--color-success);
    }

    .btn-success:hover {
      background: #2f855a;
    }

    .btn-group {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 40px;
      flex-wrap: wrap;
    }

    .status-message {
      padding: 18px;
      margin: 20px 0;
      border-radius: var(--border-radius);
      text-align: center;
      display: none;
      font-weight: 500;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .error {
      background-color: #fff5f5;
      color: var(--color-error);
      border-left: 5px solid var(--color-error);
    }

    .success {
      background-color: #f0fff4;
      color: var(--color-success);
      border-left: 5px solid var(--color-success);
    }

    .readonly-message {
      background-color: #e3f2fd;
      color: #1976d2;
      border-left: 4px solid #1976d2;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: var(--border-radius);
      text-align: center;
      font-weight: 500;
    }

    .readonly-field {
      background-color: #f5f5f5 !important;
      cursor: not-allowed !important;
    }

    .readonly-btn {
      opacity: 0.6;
      cursor: not-allowed !important;
      pointer-events: none;
    }

    .today-badge {
      background: var(--color-primary);
      color: white;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 0.85rem;
      margin-left: 8px;
      font-weight: normal;
    }

    .page-break {
      page-break-before: always;
      border-top: 2px dashed #cbd5e0;
      margin-top: 40px;
      padding-top: 40px;
    }

    .logo-img {
      max-height: 60px;
      width: auto;
    }

    .autocomplete-container {
      position: relative;
      width: 100%;
    }

    .autocomplete-items {
      position: absolute;
      border: 1px solid #d4d4d4;
      border-bottom: none;
      border-top: none;
      z-index: 99;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 200px;
      overflow-y: auto;
      background: white;
      border-radius: 0 0 var(--border-radius) var(--border-radius);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .autocomplete-item {
      padding: 10px;
      cursor: pointer;
      background-color: #fff;
      border-bottom: 1px solid #d4d4d4;
    }

    .autocomplete-item:hover {
      background-color: #e9e9e9;
    }

    @media (max-width: 1024px) {
      .axle-row {
        flex-direction: column;
      }
      
      .wheels-wrapper {
        flex-wrap: wrap;
        gap: 20px;
      }
    }

    @media (max-width: 768px) {
      .btn {
        width: 100%;
        justify-content: center;
      }

      .btn-volver {
        position: relative;
        top: 0;
        left: 0;
        margin-bottom: 15px;
        width: 100%;
        justify-content: center;
      }

      .btn-group {
        flex-direction: column;
      }
      
      .form-container {
        padding: 25px 15px;
      }
      
      .header h1 {
        font-size: 1.8rem;
      }
      
      .checklist-table {
        display: block;
        overflow-x: auto;
      }
      
      .wheels-wrapper svg {
        width: 100px;
        height: 100px;
      }
      
      .torque-ui {
        width: 60px;
      }
      
      .logo-img {
        max-height: 50px;
      }
    }
    
    @media (max-width: 480px) {
      .wheels-wrapper {
        flex-direction: column;
        gap: 15px;
      }
      
      .wheel-group {
        margin: 10px 0;
      }
      
      .logo-img {
        max-height: 40px;
      }
    }

    @media print {
      body {
        background: white;
      }
      
      .form-container {
        box-shadow: none;
      }
      
      .btn-group {
        display: none;
      }
      
      .btn-volver {
        display: none;
      }
      
      .page-break {
        border-top: 1px solid #000;
      }
      
      .autocomplete-items {
        display: none;
      }
    }
  </style>
</head>
<body>

<!-- Botón Volver -->
<button class="btn-volver" onclick="volverPaginaAnterior()">
  <i class="fas fa-arrow-left"></i> Volver
</button>

<div class="app-container">
  <div class="header">
    <h1>PAUTA PREVENTIVA DE SISTEMAS CRÍTICOS</h1>
    <p>TRANSPORTES HEREME LTDA. PROYECTO RAJO INCA - CODELCO VP</p>
    <div class="header-info">
      <div>COD: RE-MAN-004</div>
      <div>FECHA DE CREACIÓN: 05-04-2024</div>
      <div>VERSIÓN: 02</div>
    </div>
  </div>

  <div class="form-container">
    <table class="header-table">
      <tr>
        <td rowspan="2" style="width:25%; text-align: center; vertical-align: middle;">
          <img src="img/logo.png" alt="Logo HEREME" class="logo-img" onerror="this.style.display='none'; this.parentNode.innerHTML='<div class=\'logo-placeholder\'>HEREME</div>';">
        </td>
        <td colspan="2" style="text-align: center;">
          <strong>TRANSPORTES HEREME LTDA. CONTRATO SIGMA CODELCO ANDINA</strong>
        </td>
        <td style="width:20%"><strong>COD: RE-MAN-004</strong></td>
      </tr>
      <tr>
        <td><strong>FECHA:</strong> <span id="fecha-header">05-04-2024</span></td>
        <td><strong>VERSIÓN:</strong> 02</td>
        <td><strong><span id="ot-number">CARGANDO...</span></strong></td>
      </tr>
    </table>

    <table class="info-table">
      <tr>
        <td class="label">NOMBRE MECÁNICO:</td>
        <td>
          <select id="nombre_mecanico" style="width: 100%;">
            <option value="">Seleccione un mecánico</option>
          </select>
        </td>
        <td class="label">FECHA:</td>
        <td>
          <input type="date" id="fecha" style="width: 100%;">
        </td>
      </tr>
      <tr>
        <td class="label">PATENTE:</td>
        <td>
          <select id="patente" style="width: 100%;" onchange="cargarVehiculoPorPatente()">
            <option value="">Seleccione una patente</option>
          </select>
        </td>
        <td class="label">VEHÍCULO:</td>
        <td><input type="text" id="vehiculo" readonly style="background-color: #f0f0f0;"></td>
      </tr>
      <tr>
        <td class="label">KILOMETRAJE:</td>
        <td><input type="number" id="kilometraje" min="0" step="1"></td>
        <td class="label">EMPRESA:</td>
        <td><input type="text" id="empresa_asociada" value="SIGMA" readonly style="background-color: #f0f0f0;"></td>
      </tr>
      <tr>
        <td class="label">PRÓXIMA MANTENCIÓN:</td>
        <td colspan="3">
          <div style="display: flex; align-items: center; gap: 10px;">
            <input type="number" id="proxima_mantencion_km" min="0" step="1" style="flex: 1;">
            <span style="font-weight: bold; white-space: nowrap;">KM</span>
          </div>
        </td>
      </tr>
    </table>

    <div class="section">
      <h3 class="section-title"><i class="fas fa-tire"></i> SISTEMA DE RODADO</h3>
      
      <table class="checklist-table">
        <thead>
          <tr>
            <th width="60%">ITEM</th>
            <th width="15%">ESTADO</th>
            <th width="25%">OBSERVACIONES</th>
          </tr>
        </thead>
        <tbody id="sistema-rodado-body">
        </tbody>
      </table>

      <div class="torque-visual-container">
        <div class="section-header">Verificación Visual de Tornillos - Torque de Ruedas</div>
        
        <div class="axle-row">
          <div class="obs-container">
            <strong>Observaciones:</strong>
            <textarea id="obs-delantero" placeholder="Notas sobre el eje delantero..."></textarea>
          </div>
          <div class="visual-container">
            <strong>Eje Delantero</strong>
            <div class="wheels-wrapper">
              <div class="torque-ui">
                <div class="torque-head">Torque Nm</div>
                <input class="torque-input" id="torque-del-izq-input" value="">
              </div>
              <div class="wheel-group">
                <div>Izquierda</div>
                <svg viewBox="0 0 100 100" width="110" id="wheel-del-izq">
                  <circle cx="50" cy="50" r="18" fill="black" />
                  <circle class="bolt" cx="50" cy="12" r="6" data-position="1" data-wheel="del-izq" />
                  <circle class="bolt" cx="72" cy="19" r="6" data-position="2" data-wheel="del-izq" />
                  <circle class="bolt" cx="86" cy="38" r="6" data-position="3" data-wheel="del-izq" />
                  <circle class="bolt" cx="86" cy="62" r="6" data-position="4" data-wheel="del-izq" />
                  <circle class="bolt" cx="72" cy="81" r="6" data-position="5" data-wheel="del-izq" />
                  <circle class="bolt" cx="50" cy="88" r="6" data-position="6" data-wheel="del-izq" />
                  <circle class="bolt" cx="28" cy="81" r="6" data-position="7" data-wheel="del-izq" />
                  <circle class="bolt" cx="14" cy="62" r="6" data-position="8" data-wheel="del-izq" />
                  <circle class="bolt" cx="14" cy="38" r="6" data-position="9" data-wheel="del-izq" />
                  <circle class="bolt" cx="28" cy="19" r="6" data-position="10" data-wheel="del-izq" />
                </svg>
              </div>
              <div class="wheel-group">
                <div>Derecha</div>
                <svg viewBox="0 0 100 100" width="110" id="wheel-del-der">
                  <circle cx="50" cy="50" r="18" fill="black" />
                  <circle class="bolt" cx="50" cy="12" r="6" data-position="1" data-wheel="del-der" />
                  <circle class="bolt" cx="72" cy="19" r="6" data-position="2" data-wheel="del-der" />
                  <circle class="bolt" cx="86" cy="38" r="6" data-position="3" data-wheel="del-der" />
                  <circle class="bolt" cx="86" cy="62" r="6" data-position="4" data-wheel="del-der" />
                  <circle class="bolt" cx="72" cy="81" r="6" data-position="5" data-wheel="del-der" />
                  <circle class="bolt" cx="50" cy="88" r="6" data-position="6" data-wheel="del-der" />
                  <circle class="bolt" cx="28" cy="81" r="6" data-position="7" data-wheel="del-der" />
                  <circle class="bolt" cx="14" cy="62" r="6" data-position="8" data-wheel="del-der" />
                  <circle class="bolt" cx="14" cy="38" r="6" data-position="9" data-wheel="del-der" />
                  <circle class="bolt" cx="28" cy="19" r="6" data-position="10" data-wheel="del-der" />
                </svg>
              </div>
              <div class="torque-ui">
                <div class="torque-head">Torque Nm</div>
                <input class="torque-input" id="torque-del-der-input" value="">
              </div>
            </div>
          </div>
        </div>

        <div class="axle-row">
          <div class="obs-container">
            <strong>Observaciones:</strong>
            <textarea id="obs-trasero" placeholder="Notas sobre el eje trasero..."></textarea>
          </div>
          <div class="visual-container">
            <strong>Eje Trasero</strong>
            <div class="wheels-wrapper">
              <div class="torque-ui">
                <div class="torque-head">Torque Nm</div>
                <input class="torque-input" id="torque-tra-izq-input" value="">
              </div>
              <div class="wheel-group">
                <div>Izquierda</div>
                <svg viewBox="0 0 100 100" width="110" id="wheel-tra-izq">
                  <circle cx="50" cy="50" r="18" fill="black" />
                  <circle class="bolt" cx="50" cy="12" r="6" data-position="1" data-wheel="tra-izq" />
                  <circle class="bolt" cx="72" cy="19" r="6" data-position="2" data-wheel="tra-izq" />
                  <circle class="bolt" cx="86" cy="38" r="6" data-position="3" data-wheel="tra-izq" />
                  <circle class="bolt" cx="86" cy="62" r="6" data-position="4" data-wheel="tra-izq" />
                  <circle class="bolt" cx="72" cy="81" r="6" data-position="5" data-wheel="tra-izq" />
                  <circle class="bolt" cx="50" cy="88" r="6" data-position="6" data-wheel="tra-izq" />
                  <circle class="bolt" cx="28" cy="81" r="6" data-position="7" data-wheel="tra-izq" />
                  <circle class="bolt" cx="14" cy="62" r="6" data-position="8" data-wheel="tra-izq" />
                  <circle class="bolt" cx="14" cy="38" r="6" data-position="9" data-wheel="tra-izq" />
                  <circle class="bolt" cx="28" cy="19" r="6" data-position="10" data-wheel="tra-izq" />
                </svg>
              </div>
              <div class="wheel-group">
                <div>Derecha</div>
                <svg viewBox="0 0 100 100" width="110" id="wheel-tra-der">
                  <circle cx="50" cy="50" r="18" fill="black" />
                  <circle class="bolt" cx="50" cy="12" r="6" data-position="1" data-wheel="tra-der" />
                  <circle class="bolt" cx="72" cy="19" r="6" data-position="2" data-wheel="tra-der" />
                  <circle class="bolt" cx="86" cy="38" r="6" data-position="3" data-wheel="tra-der" />
                  <circle class="bolt" cx="86" cy="62" r="6" data-position="4" data-wheel="tra-der" />
                  <circle class="bolt" cx="72" cy="81" r="6" data-position="5" data-wheel="tra-der" />
                  <circle class="bolt" cx="50" cy="88" r="6" data-position="6" data-wheel="tra-der" />
                  <circle class="bolt" cx="28" cy="81" r="6" data-position="7" data-wheel="tra-der" />
                  <circle class="bolt" cx="14" cy="62" r="6" data-position="8" data-wheel="tra-der" />
                  <circle class="bolt" cx="14" cy="38" r="6" data-position="9" data-wheel="tra-der" />
                  <circle class="bolt" cx="28" cy="19" r="6" data-position="10" data-wheel="tra-der" />
                </svg>
              </div>
              <div class="torque-ui">
                <div class="torque-head">Torque Nm</div>
                <input class="torque-input" id="torque-tra-der-input" value="">
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div style="margin-top: 30px;">
        <label for="observaciones_rodado">
          <i class="fas fa-clipboard-list"></i> OBSERVACIONES GENERALES DEL SISTEMA DE RODADO:
        </label>
        <textarea id="observaciones_rodado" rows="4" placeholder="Observaciones generales sobre el sistema de rodado..."></textarea>
      </div>
    </div>

    <div class="page-break">
      <div class="section">
        <h3 class="section-title"><i class="fas fa-stop-circle"></i> SISTEMA DE FRENOS</h3>
        
        <table class="checklist-table">
          <thead>
            <tr>
              <th width="60%">ITEM</th>
              <th width="15%">ESTADO</th>
              <th width="25%">OBSERVACIONES</th>
            </tr>
          </thead>
          <tbody id="sistema-frenos-body">
          </tbody>
        </table>
        
        <div style="margin-top: 20px;">
          <label for="observaciones_frenos">OBSERVACIONES GENERALES DEL SISTEMA DE FRENOS:</label>
          <textarea id="observaciones_frenos" rows="3" placeholder="Observaciones generales..."></textarea>
        </div>
      </div>

      <div class="section">
        <h3 class="section-title"><i class="fas fa-cogs"></i> COMPONENTES DE TRANSMISIÓN</h3>
        
        <table class="checklist-table">
          <thead>
            <tr>
              <th width="60%">ITEM</th>
              <th width="15%">ESTADO</th>
              <th width="25%">OBSERVACIONES</th>
            </tr>
          </thead>
          <tbody id="transmision-body">
          </tbody>
        </table>
        
        <div style="margin-top: 20px;">
          <label for="observaciones_transmision">OBSERVACIONES GENERALES DE TRANSMISIÓN:</label>
          <textarea id="observaciones_transmision" rows="2" placeholder="Observaciones generales..."></textarea>
        </div>
      </div>

      <div class="section">
        <h3 class="section-title"><i class="fas fa-car-side"></i> COMPONENTES DE SUSPENSIÓN</h3>
        
        <table class="checklist-table">
          <thead>
            <tr>
              <th width="60%">ITEM</th>
              <th width="15%">ESTADO</th>
              <th width="25%">OBSERVACIONES</th>
            </tr>
          </thead>
          <tbody id="suspension-body">
          </tbody>
        </table>
        
        <div style="margin-top: 20px;">
          <label for="observaciones_suspension">OBSERVACIONES GENERALES DE SUSPENSIÓN:</label>
          <textarea id="observaciones_suspension" rows="2" placeholder="Observaciones generales..."></textarea>
        </div>
      </div>

      <div class="section">
        <h3 class="section-title"><i class="fas fa-steering-wheel"></i> COMPONENTES DE DIRECCIÓN</h3>
        
        <table class="checklist-table">
          <thead>
            <tr>
              <th width="60%">ITEM</th>
              <th width="15%">ESTADO</th>
              <th width="25%">OBSERVACIONES</th>
            </tr>
          </thead>
          <tbody id="direccion-body">
          </tbody>
        </table>
        
        <div style="margin-top: 20px;">
          <label for="observaciones_direccion">OBSERVACIONES GENERALES DE DIRECCIÓN:</label>
          <textarea id="observaciones_direccion" rows="2" placeholder="Observaciones generales..."></textarea>
        </div>
      </div>

      <div class="section">
        <h3 class="section-title"><i class="fas fa-engine"></i> MOTOR</h3>
        
        <table class="checklist-table">
          <thead>
            <tr>
              <th width="60%">ITEM</th>
              <th width="15%">ESTADO</th>
              <th width="25%">OBSERVACIONES</th>
            </tr>
          </thead>
          <tbody id="motor-body">
          </tbody>
        </table>
        
        <div style="margin-top: 20px;">
          <label for="observaciones_motor">OBSERVACIONES GENERALES DEL MOTOR:</label>
          <textarea id="observaciones_motor" rows="3" placeholder="Observaciones generales..."></textarea>
        </div>
      </div>

      <div class="section">
        <h3 class="section-title"><i class="fas fa-check-double"></i> OTROS PUNTOS A CHEQUEAR</h3>
        
        <table class="checklist-table">
          <thead>
            <tr>
              <th width="60%">ITEM</th>
              <th width="15%">ESTADO</th>
              <th width="25%">OBSERVACIONES</th>
            </tr>
          </thead>
          <tbody id="otros-body">
          </tbody>
        </table>
        
        <div style="margin-top: 20px;">
          <label for="observaciones_otros">OBSERVACIONES GENERALES:</label>
          <textarea id="observaciones_otros" rows="3" placeholder="Observaciones generales..."></textarea>
        </div>
      </div>

      <div class="section">
        <h3 class="section-title"><i class="fas fa-signature"></i> FIRMA DEL MECÁNICO</h3>
        
        <div style="margin-top: 20px;">
          <label for="observaciones_finales">OBSERVACIONES DEL MANTENEDOR:</label>
          <textarea id="observaciones_finales" rows="4" placeholder="Observaciones finales del mantenedor..."></textarea>
        </div>
        
        <div style="margin-top: 30px; padding-top: 15px; border-top: 2px solid #d1d5db;">
          <div>
            <label for="firma_mecanico">NOMBRE Y FIRMA DEL MECÁNICO:</label>
            <input type="text" id="firma_mecanico" style="width: 100%;" readonly>
            <div style="height: 2px; background: #2d3748; margin-top: 30px;"></div>
            <div style="text-align: center; margin-top: 5px; color: #718096;">FIRMA</div>
          </div>
        </div>
      </div>
    </div>

    <div id="error-message" class="status-message error" style="display: none;"></div>
    <div id="success-message" class="status-message success" style="display: none;"></div>

    <div class="btn-group">
      <button class="btn btn-success" onclick="guardarMantenimiento()">
        <i class="fas fa-save"></i> GUARDAR PAUTA PREVENTIVA
      </button>
      <button class="btn btn-secondary" onclick="limpiarFormulario()">
        <i class="fas fa-eraser"></i> LIMPIAR FORMULARIO
      </button>
      <button class="btn btn-primary" onclick="window.print()">
        <i class="fas fa-print"></i> IMPRIMIR
      </button>
    </div>
  </div>
</div>

<script>
  // Función para volver a la página anterior
  function volverPaginaAnterior() {
    // Intentar volver en el historial del navegador
    if (window.history.length > 1) {
      window.history.back();
    } else {
      // Si no hay historial, redirigir a una página por defecto
      window.location.href = 'index.html';
    }
  }

  // Configuración de Supabase
  const SUPABASE_URL = 'https://jrbluqwjmjsfoezzmjno.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_Aw4gC43MsdZBMcTUnFT9Kg_hvfvDVHH';
  
  // Inicializar cliente Supabase
  const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // Variables globales
  let mecanicos = [];
  let maquinas = [];
  let siguienteOT = 1;

  // Datos completos de los items del checklist
  const checklistItems = {
    sistemaRodado: [
      { id: 1, descripcion: "Inspección y limpieza de llantas" },
      { id: 2, descripcion: "Inspección y limpieza de pernos" },
      { id: 3, descripcion: "Inspección y limpieza de tuercas" },
      { id: 4, descripcion: "Inspección rueda repuesto" },
      { id: 5, descripcion: "Torque de ruedas (Sprinter 516 133lbs)" },
      { id: 6, descripcion: "Check point" },
      { id: 7, descripcion: "Chequeo milimétrico de rodadura neumáticos y deformación (3mm mín.de profundidad)" },
      { id: 8, descripcion: "Comprobar y restablecer la presión de aire de los neumáticos 40 psi" },
      { id: 9, descripcion: "Estado de las llantas (orificio central y orificio pernos)" },
      { id: 10, descripcion: "Comprobar los neumáticos respecto a daños y agrietamientos." }
    ],
    sistemaFrenos: [
      { id: 11, descripcion: "Inspección y limpieza de Caliper" },
      { id: 12, descripcion: "Inspección y limpieza de Porta Caliper" },
      { id: 13, descripcion: "Pasadores de Caliper de Frenos (Engrase)" },
      { id: 14, descripcion: "Inspección y limpieza de Discos" },
      { id: 15, descripcion: "Inspección y limpieza de Balatas" },
      { id: 16, descripcion: "Inspección de Flexibles" },
      { id: 17, descripcion: "Revisión freno de mano." },
      { id: 18, descripcion: "Inspección visual de pastillas de frenos delanteros y traseros (Cambio hasta 80% de desgaste)" }
    ],
    transmision: [
      { id: 19, descripcion: "Chequeo de holgura de crucetas, machón y rodamiento central cardán" }
    ],
    suspension: [
      { id: 20, descripcion: "Chequeo de Suspensión (amortiguadores, cazoletas, bieletas)" },
      { id: 21, descripcion: "Revisión Silentblock" }
    ],
    direccion: [
      { id: 22, descripcion: "Revisión holgura de puntas, rótulas, axiales" }
    ],
    motor: [
      { id: 23, descripcion: "Revisión del nivel de aceite del motor" },
      { id: 24, descripcion: "Revisión de Aceite Hidráulico (ATF)" },
      { id: 25, descripcion: "Revisión de Líquido Refrigerante" },
      { id: 26, descripcion: "Revisión de Nivel de Líquido de freno" },
      { id: 27, descripcion: "Revisión de correas de Accesorios" },
      { id: 28, descripcion: "Revisión de mangueras." }
    ],
    otros: [
      { id: 29, descripcion: "Aire acondicionado / Calefacción" },
      { id: 30, descripcion: "Cinturones de seguridad" },
      { id: 31, descripcion: "Chequeo de luces / foco faenero / pértiga" },
      { id: 32, descripcion: "Revisión cámara de retroceso y sensores de proximidad" },
      { id: 33, descripcion: "Revisión de batería (Terminales sueltos) y carga de alternador" },
      { id: 34, descripcion: "Chequeo de niveles agua limpiaparabrisas." },
      { id: 35, descripcion: "Chequeo de testigos (Uso de Escáner)." },
      { id: 36, descripcion: "Lavado carrocería General (Bajo Chasis)" }
    ]
  };

  // Estado de los pernos
  let boltsState = {
    'del-izq': {1: false, 2: false, 3: false, 4: false, 5: false, 6: false, 7: false, 8: false, 9: false, 10: false},
    'del-der': {1: false, 2: false, 3: false, 4: false, 5: false, 6: false, 7: false, 8: false, 9: false, 10: false},
    'tra-izq': {1: false, 2: false, 3: false, 4: false, 5: false, 6: false, 7: false, 8: false, 9: false, 10: false},
    'tra-der': {1: false, 2: false, 3: false, 4: false, 5: false, 6: false, 7: false, 8: false, 9: false, 10: false}
  };

  // Función para obtener el siguiente número OT (basado en el próximo id)
  async function obtenerSiguienteOT() {
    try {
      // Obtener el último ID de la tabla mantenimientos
      const { data, error } = await supabaseClient
        .from('mantenimientos')
        .select('id')
        .order('id', { ascending: false })
        .limit(1);
      
      if (error) {
        console.error('Error al obtener último ID:', error);
        siguienteOT = 1;
      } else if (data && data.length > 0) {
        // El siguiente OT será el próximo ID
        siguienteOT = data[0].id + 1;
      } else {
        // Si no hay registros, empezar en 1
        siguienteOT = 1;
      }
      
      // Actualizar el elemento en la página
      const otElement = document.getElementById('ot-number');
      if (otElement) {
        otElement.textContent = `OT ${siguienteOT.toString().padStart(4, '0')}`;
      }
      
      console.log(`Próximo OT (basado en ID): ${siguienteOT}`);
      return siguienteOT;
    } catch (error) {
      console.error('Error en obtenerSiguienteOT:', error);
      const otElement = document.getElementById('ot-number');
      if (otElement) {
        otElement.textContent = 'OT 0001';
      }
      return 1;
    }
  }

  // Función para cargar datos desde Supabase (MODIFICADA para incluir todas las tablas)
  async function cargarDatos() {
    try {
      // Obtener el siguiente número OT
      await obtenerSiguienteOT();
      
      // Cargar mecánicos de todas las tablas
      await cargarTodosMecanicos();
      
      // Cargar máquinas
      const { data: maquinasData, error: errorMaquinas } = await supabaseClient
        .from('maquinas')
        .select('id, patente, modelo')
        .order('patente');
      
      if (errorMaquinas) {
        console.error('Error al cargar máquinas:', errorMaquinas);
        maquinas = [];
      } else {
        maquinas = maquinasData || [];
      }
      
      // Poblar selects
      poblarSelectMecanicos();
      poblarSelectPatentes();
      
      console.log('Datos cargados:', {
        mecanicos: mecanicos.length,
        maquinas: maquinas.length,
        siguienteOT: siguienteOT
      });
      
      return true;
    } catch (error) {
      console.error('Error general al cargar datos:', error);
      mostrarError('Error al cargar datos: ' + error.message);
      return false;
    }
  }

  // Función para cargar todos los mecánicos de las diferentes tablas (NUEVA FUNCIÓN)
  async function cargarTodosMecanicos() {
    try {
      // Array para almacenar todos los nombres únicos
      const nombresUnicos = new Set();
      mecanicos = [];
      
      // 1. Cargar mecánicos de la tabla 'mecanicos'
      const { data: dataMecanicos, error: errorMecanicos } = await supabaseClient
        .from('mecanicos')
        .select('id, nombre')
        .order('nombre');
      
      if (!errorMecanicos && dataMecanicos) {
        dataMecanicos.forEach(mec => {
          if (mec.nombre && !nombresUnicos.has(mec.nombre)) {
            nombresUnicos.add(mec.nombre);
            mecanicos.push({
              id: mec.id,
              nombre: mec.nombre,
              tipo: 'mecanico'
            });
          }
        });
      } else {
        console.error('Error al cargar mecánicos:', errorMecanicos);
      }
      
      // 2. Cargar gerentes de operaciones de la tabla 'gerentes_operaciones'
      const { data: dataGerentes, error: errorGerentes } = await supabaseClient
        .from('gerentes_operaciones')
        .select('id, nombre')
        .order('nombre');
      
      if (!errorGerentes && dataGerentes) {
        dataGerentes.forEach(gerente => {
          if (gerente.nombre && !nombresUnicos.has(gerente.nombre)) {
            nombresUnicos.add(gerente.nombre);
            mecanicos.push({
              id: gerente.id,
              nombre: gerente.nombre,
              tipo: 'gerente_operaciones'
            });
          }
        });
      } else {
        console.error('Error al cargar gerentes de operaciones:', errorGerentes);
      }
      
      // 3. Cargar jefes de mantenimiento de la tabla 'jefes_mantenimiento'
      const { data: dataJefes, error: errorJefes } = await supabaseClient
        .from('jefes_mantenimiento')
        .select('id, nombre')
        .order('nombre');
      
      if (!errorJefes && dataJefes) {
        dataJefes.forEach(jefe => {
          if (jefe.nombre && !nombresUnicos.has(jefe.nombre)) {
            nombresUnicos.add(jefe.nombre);
            mecanicos.push({
              id: jefe.id,
              nombre: jefe.nombre,
              tipo: 'jefe_mantenimiento'
            });
          }
        });
      } else {
        console.error('Error al cargar jefes de mantenimiento:', errorJefes);
      }
      
      // Ordenar alfabéticamente por nombre
      mecanicos.sort((a, b) => a.nombre.localeCompare(b.nombre));
      
      console.log(`Total de nombres cargados: ${mecanicos.length}`);
      console.log('Tipos de usuarios cargados:', {
        mecanicos: mecanicos.filter(m => m.tipo === 'mecanico').length,
        gerentes: mecanicos.filter(m => m.tipo === 'gerente_operaciones').length,
        jefes: mecanicos.filter(m => m.tipo === 'jefe_mantenimiento').length
      });
      
      return mecanicos;
    } catch (error) {
      console.error('Error en cargarTodosMecanicos:', error);
      return [];
    }
  }

  // Función para poblar el select de mecánicos (MODIFICADA)
  function poblarSelectMecanicos() {
    const select = document.getElementById('nombre_mecanico');
    select.innerHTML = '<option value="">Seleccione un mecánico</option>';
    
    mecanicos.forEach(persona => {
      const option = document.createElement('option');
      option.value = persona.nombre;
      option.textContent = persona.nombre;
      option.dataset.tipo = persona.tipo || 'mecanico';
      select.appendChild(option);
    });
    
    // Actualizar firma del mecánico cuando se selecciona
    select.addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      document.getElementById('firma_mecanico').value = this.value;
      
      // Mostrar en consola el tipo de usuario seleccionado (para depuración)
      if (selectedOption.dataset.tipo) {
        console.log(`Usuario seleccionado: ${this.value}, Tipo: ${selectedOption.dataset.tipo}`);
      }
    });
    
    console.log(`Select de mecánicos poblado con ${mecanicos.length} opciones`);
  }

  // Función para poblar el select de patentes
  function poblarSelectPatentes() {
    const select = document.getElementById('patente');
    select.innerHTML = '<option value="">Seleccione una patente</option>';
    
    maquinas.forEach(maquina => {
      const option = document.createElement('option');
      option.value = maquina.patente;
      option.textContent = maquina.patente;
      option.dataset.modelo = maquina.modelo || '';
      select.appendChild(option);
    });
  }

  // Función para cargar vehículo según patente
  function cargarVehiculoPorPatente() {
    const patenteSelect = document.getElementById('patente');
    const selectedOption = patenteSelect.options[patenteSelect.selectedIndex];
    const vehiculoInput = document.getElementById('vehiculo');
    
    if (selectedOption && selectedOption.dataset.modelo) {
      vehiculoInput.value = selectedOption.dataset.modelo;
    } else {
      vehiculoInput.value = '';
    }
  }

  // Función para calcular próxima mantención en KM (kilometraje actual + 5000)
  function calcularProximaMantencionKM() {
    const kilometrajeInput = document.getElementById('kilometraje');
    const proximaMantencionInput = document.getElementById('proxima_mantencion_km');
    
    // Agregar event listener para calcular automáticamente
    kilometrajeInput.addEventListener('input', function() {
      const kilometrajeActual = parseInt(this.value) || 0;
      if (kilometrajeActual > 0) {
        const proximaKM = kilometrajeActual + 5000;
        proximaMantencionInput.value = proximaKM;
      } else {
        proximaMantencionInput.value = '';
      }
    });
    
    // También permitir edición manual
    console.log('Calculadora de próxima mantención configurada');
  }

  // Función para crear una fila de checklist
  function crearFilaChecklist(item, seccion) {
    const tr = document.createElement('tr');
    tr.dataset.id = item.id;
    tr.dataset.seccion = seccion;
    
    // Celda de descripción
    const tdDesc = document.createElement('td');
    const divCheckItem = document.createElement('div');
    divCheckItem.className = 'check-item';
    
    const divNumero = document.createElement('div');
    divNumero.className = 'item-number';
    divNumero.textContent = item.id;
    
    const divDescripcion = document.createElement('div');
    divDescripcion.className = 'item-description';
    divDescripcion.textContent = item.descripcion;
    
    divCheckItem.appendChild(divNumero);
    divCheckItem.appendChild(divDescripcion);
    tdDesc.appendChild(divCheckItem);
    
    // Celda de estado
    const tdEstado = document.createElement('td');
    const divCircleCheckbox = document.createElement('div');
    divCircleCheckbox.className = 'circle-checkbox';
    
    // Opción SI
    const divSi = document.createElement('div');
    divSi.className = 'circle-option';
    const circleSi = document.createElement('div');
    circleSi.className = 'circle';
    circleSi.dataset.value = 'si';
    circleSi.dataset.itemId = item.id;
    circleSi.dataset.seccion = seccion;
    circleSi.onclick = () => toggleCircle(circleSi, 'si');
    const labelSi = document.createElement('div');
    labelSi.className = 'circle-label';
    labelSi.textContent = 'SI';
    divSi.appendChild(circleSi);
    divSi.appendChild(labelSi);
    
    // Opción NO
    const divNo = document.createElement('div');
    divNo.className = 'circle-option';
    const circleNo = document.createElement('div');
    circleNo.className = 'circle';
    circleNo.dataset.value = 'no';
    circleNo.dataset.itemId = item.id;
    circleNo.dataset.seccion = seccion;
    circleNo.onclick = () => toggleCircle(circleNo, 'no');
    const labelNo = document.createElement('div');
    labelNo.className = 'circle-label';
    labelNo.textContent = 'NO';
    divNo.appendChild(circleNo);
    divNo.appendChild(labelNo);
    
    divCircleCheckbox.appendChild(divSi);
    divCircleCheckbox.appendChild(divNo);
    tdEstado.appendChild(divCircleCheckbox);
    
    // Celda de observaciones
    const tdObs = document.createElement('td');
    const textareaObs = document.createElement('textarea');
    textareaObs.className = 'item-observacion';
    textareaObs.dataset.itemId = item.id;
    textareaObs.dataset.seccion = seccion;
    textareaObs.placeholder = 'Observaciones...';
    textareaObs.rows = 2;
    textareaObs.style.width = '100%';
    tdObs.appendChild(textareaObs);
    
    tr.appendChild(tdDesc);
    tr.appendChild(tdEstado);
    tr.appendChild(tdObs);
    
    return tr;
  }

  // Función para alternar casillas circulares
  function toggleCircle(circleElement, valor) {
    const itemId = circleElement.dataset.itemId;
    const seccion = circleElement.dataset.seccion;
    
    const todasCasillas = document.querySelectorAll(`.circle[data-item-id="${itemId}"]`);
    
    todasCasillas.forEach(circle => {
      circle.classList.remove('selected');
    });
    
    circleElement.classList.add('selected');
    
    actualizarEstadoItem(itemId, seccion, valor);
  }

  // Función para alternar estado de pernos
  function toggleBolt(boltElement) {
    const position = parseInt(boltElement.dataset.position);
    const wheel = boltElement.dataset.wheel;
    
    boltsState[wheel][position] = !boltsState[wheel][position];
    
    if (boltsState[wheel][position]) {
      boltElement.classList.add('marked');
    } else {
      boltElement.classList.remove('marked');
    }
  }

  // Función para actualizar estado de un ítem
  function actualizarEstadoItem(itemId, seccion, estado) {
    if (!window.checklistData) window.checklistData = {};
    if (!window.checklistData[seccion]) window.checklistData[seccion] = {};
    
    window.checklistData[seccion][itemId] = {
      estado: estado,
      observacion: document.querySelector(`textarea[data-item-id="${itemId}"][data-seccion="${seccion}"]`)?.value || ''
    };
  }

  // Función para poblar todos los checklists
  function poblarTodosChecklists() {
    // Sistema de rodado
    const cuerpoRodado = document.getElementById('sistema-rodado-body');
    cuerpoRodado.innerHTML = '';
    checklistItems.sistemaRodado.forEach(item => {
      cuerpoRodado.appendChild(crearFilaChecklist(item, 'sistemaRodado'));
    });
    
    // Sistema de frenos
    const cuerpoFrenos = document.getElementById('sistema-frenos-body');
    cuerpoFrenos.innerHTML = '';
    checklistItems.sistemaFrenos.forEach(item => {
      cuerpoFrenos.appendChild(crearFilaChecklist(item, 'sistemaFrenos'));
    });
    
    // Transmisión
    const cuerpoTransmision = document.getElementById('transmision-body');
    cuerpoTransmision.innerHTML = '';
    checklistItems.transmision.forEach(item => {
      cuerpoTransmision.appendChild(crearFilaChecklist(item, 'transmision'));
    });
    
    // Suspensión
    const cuerposuspension = document.getElementById('suspension-body');
    cuerposuspension.innerHTML = '';
    checklistItems.suspension.forEach(item => {
      cuerposuspension.appendChild(crearFilaChecklist(item, 'suspension'));
    });
    
    // Dirección
    const cuerpoDireccion = document.getElementById('direccion-body');
    cuerpoDireccion.innerHTML = '';
    checklistItems.direccion.forEach(item => {
      cuerpoDireccion.appendChild(crearFilaChecklist(item, 'direccion'));
    });
    
    // Motor
    const cuerpoMotor = document.getElementById('motor-body');
    cuerpoMotor.innerHTML = '';
    checklistItems.motor.forEach(item => {
      cuerpoMotor.appendChild(crearFilaChecklist(item, 'motor'));
    });
    
    // Otros
    const cuerpoOtros = document.getElementById('otros-body');
    cuerpoOtros.innerHTML = '';
    checklistItems.otros.forEach(item => {
      cuerpoOtros.appendChild(crearFilaChecklist(item, 'otros'));
    });
    
    console.log('Checklists poblados');
  }

  // Función para establecer fecha actual
  function setCurrentDateTime() {
    const now = new Date();
    
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const today = `${year}-${month}-${day}`;
    const todayDisplay = `${day}-${month}-${year}`;
    
    const fechaInput = document.getElementById('fecha');
    fechaInput.value = today;
    
    document.getElementById('fecha-header').textContent = todayDisplay;
    
    console.log('Fecha actual establecida');
  }

  // Mostrar mensaje de error
  function mostrarError(mensaje) {
    const errorElement = document.getElementById('error-message');
    if (errorElement) {
      errorElement.textContent = mensaje;
      errorElement.style.display = 'block';
      
      setTimeout(() => {
        errorElement.style.display = 'none';
      }, 5000);
    } else {
      alert('Error: ' + mensaje);
    }
  }

  // Mostrar mensaje de éxito
  function mostrarExito(mensaje) {
    const successElement = document.getElementById('success-message');
    if (successElement) {
      successElement.textContent = mensaje;
      successElement.style.display = 'block';
      
      setTimeout(() => {
        successElement.style.display = 'none';
      }, 3000);
    } else {
      alert('Éxito: ' + mensaje);
    }
  }

  // Función para recolectar datos del checklist
  function recolectarDatosChecklist() {
    const datos = {};
    
    for (const seccion in checklistItems) {
      if (checklistItems.hasOwnProperty(seccion)) {
        datos[seccion] = {};
        
        checklistItems[seccion].forEach(item => {
          const circleSelected = document.querySelector(`.circle[data-item-id="${item.id}"].selected`);
          const estado = circleSelected ? circleSelected.dataset.value : null;
          
          const textareaObs = document.querySelector(`textarea[data-item-id="${item.id}"]`);
          const observacion = textareaObs ? textareaObs.value : '';
          
          datos[seccion][item.id] = {
            id: item.id,
            descripcion: item.descripcion,
            estado: estado,
            observacion: observacion
          };
        });
      }
    }
    
    return datos;
  }

  // Función para formatear hora en formato 24h (HH:MM)
  function formatearHora24h() {
    const now = new Date();
    const horas = String(now.getHours()).padStart(2, '0');
    const minutos = String(now.getMinutes()).padStart(2, '0');
    return `${horas}:${minutos}`;
  }

  // Función para guardar en Supabase (CORREGIDA)
  async function guardarMantenimiento() {
    const tipoUsuario = sessionStorage.getItem('tipoUsuario');
    if (tipoUsuario === 'lectura') {
      mostrarError('No tienes permisos para guardar. Modo de solo lectura.');
      return;
    }

    // Validar campos obligatorios
    const camposObligatorios = [
      { id: 'nombre_mecanico', nombre: 'Nombre de Mecánico' },
      { id: 'patente', nombre: 'Patente' },
      { id: 'fecha', nombre: 'Fecha' },
      { id: 'kilometraje', nombre: 'Kilometraje' }
    ];
    
    for (const campo of camposObligatorios) {
      const elemento = document.getElementById(campo.id);
      const valor = elemento.value ? elemento.value.trim() : '';
      if (!valor) {
        mostrarError(`El campo "${campo.nombre}" es obligatorio`);
        elemento.focus();
        return;
      }
    }
    
    // Validar próxima mantención KM
    const proximaMantencionInput = document.getElementById('proxima_mantencion_km');
    const proximaMantencionKM = proximaMantencionInput.value ? parseInt(proximaMantencionInput.value) : 0;
    if (proximaMantencionKM <= 0) {
      mostrarError('El campo "PRÓXIMA MANTENCIÓN" debe ser un número positivo en KM');
      proximaMantencionInput.focus();
      return;
    }
    
    // Obtener el número OT (será el próximo ID)
    const otNumero = siguienteOT;
    const otFormateado = otNumero.toString().padStart(4, '0');
    
    // Recolectar datos del checklist
    const datosChecklist = recolectarDatosChecklist();
    
    // Obtener hora formateada en 24h
    const hora24h = formatearHora24h();
    
    // Obtener el tipo de usuario seleccionado
    const mecanicoSelect = document.getElementById('nombre_mecanico');
    const selectedOption = mecanicoSelect.options[mecanicoSelect.selectedIndex];
    const tipoUsuarioSeleccionado = selectedOption.dataset.tipo || 'mecanico';
    
    // Crear objeto de datos para Supabase
    const datos = {
      tipo: 'pauta_5000',
      tipo_mantenimiento: 'Preventivo',
      patente: document.getElementById('patente').value,
      fecha: document.getElementById('fecha').value,
      hora: hora24h,
      kilometraje: parseInt(document.getElementById('kilometraje').value) || 0,
      responsable: document.getElementById('nombre_mecanico').value,
      realizado: true,
      descripcion: 'Pauta preventiva de sistemas críticos cada 5000KM',
      hecho_por: document.getElementById('nombre_mecanico').value,
      cargo_hecho_por: tipoUsuarioSeleccionado === 'gerente_operaciones' ? 'Gerente de Operaciones' : 
                     tipoUsuarioSeleccionado === 'jefe_mantenimiento' ? 'Jefe de Mantenimiento' : 'Mecánico',
      
      // Nuevos campos (usando las columnas existentes)
      numero_ot: otNumero,
      empresa_asociada: document.getElementById('empresa_asociada').value,
      vehiculo: document.getElementById('vehiculo').value,
      proxima_mantencion_km: proximaMantencionKM,
      torque_del_izq: document.getElementById('torque-del-izq-input').value,
      torque_del_der: document.getElementById('torque-del-der-input').value,
      torque_tra_izq: document.getElementById('torque-tra-izq-input').value,
      torque_tra_der: document.getElementById('torque-tra-der-input').value,
      obs_delantero: document.getElementById('obs-delantero').value,
      obs_trasero: document.getElementById('obs-trasero').value,
      observaciones_rodado: document.getElementById('observaciones_rodado').value,
      observaciones_frenos: document.getElementById('observaciones_frenos').value,
      observaciones_transmision: document.getElementById('observaciones_transmision').value,
      observaciones_suspension: document.getElementById('observaciones_suspension').value,
      observaciones_direccion: document.getElementById('observaciones_direccion').value,
      observaciones_motor: document.getElementById('observaciones_motor').value,
      observaciones_otros: document.getElementById('observaciones_otros').value,
      observaciones_finales: document.getElementById('observaciones_finales').value,
      firma_mecanico: document.getElementById('firma_mecanico').value,
      
      // Usar las columnas JSON existentes
      insumos: boltsState,
      checklist_data: datosChecklist,
      verificacion_tornillos: boltsState,
      created_at: new Date().toISOString()
    };
    
    // Remover campos vacíos para evitar errores
    Object.keys(datos).forEach(key => {
      if (datos[key] === undefined || datos[key] === null || datos[key] === '') {
        delete datos[key];
      }
    });
    
    try {
      console.log('Guardando datos:', datos);
      
      // Insertar en Supabase
      const { data, error } = await supabaseClient
        .from('mantenimientos')
        .insert([datos])
        .select();

      if (error) {
        console.error('Error de Supabase:', error);
        throw error;
      }

      console.log('Guardado exitoso:', data);

      // Actualizar el número OT para el siguiente formulario
      await obtenerSiguienteOT();

      mostrarExito(`Pauta preventiva guardada correctamente con OT ${otFormateado}`);
      
    } catch (error) {
      console.error('Error al guardar:', error);
      mostrarError('Error al guardar la pauta preventiva: ' + error.message);
    }
  }

  // Función para limpiar formulario
  function limpiarFormulario() {
    if (confirm('¿Está seguro de que desea limpiar todo el formulario? Se perderán todos los datos no guardados.')) {
      // Limpiar campos
      document.getElementById('nombre_mecanico').selectedIndex = 0;
      document.getElementById('patente').selectedIndex = 0;
      document.getElementById('kilometraje').value = '';
      document.getElementById('proxima_mantencion_km').value = '';
      document.getElementById('observaciones_rodado').value = '';
      document.getElementById('observaciones_frenos').value = '';
      document.getElementById('observaciones_transmision').value = '';
      document.getElementById('observaciones_suspension').value = '';
      document.getElementById('observaciones_direccion').value = '';
      document.getElementById('observaciones_motor').value = '';
      document.getElementById('observaciones_otros').value = '';
      document.getElementById('observaciones_finales').value = '';
      document.getElementById('firma_mecanico').value = '';
      document.getElementById('obs-delantero').value = '';
      document.getElementById('obs-trasero').value = '';
      document.getElementById('vehiculo').value = '';
      
      // Limpiar campos de torque
      document.getElementById('torque-del-izq-input').value = '';
      document.getElementById('torque-del-der-input').value = '';
      document.getElementById('torque-tra-izq-input').value = '';
      document.getElementById('torque-tra-der-input').value = '';
      
      // Limpiar casillas circulares
      document.querySelectorAll('.circle').forEach(circle => {
        circle.classList.remove('selected');
      });
      
      // Limpiar observaciones de items
      document.querySelectorAll('.item-observacion').forEach(textarea => {
        textarea.value = '';
      });
      
      // Limpiar pernos
      document.querySelectorAll('.bolt').forEach(bolt => {
        bolt.classList.remove('marked');
      });
      
      // Restablecer fecha
      setCurrentDateTime();
      
      // Limpiar objetos de datos
      window.checklistData = {};
      boltsState = {
        'del-izq': {1: false, 2: false, 3: false, 4: false, 5: false, 6: false, 7: false, 8: false, 9: false, 10: false},
        'del-der': {1: false, 2: false, 3: false, 4: false, 5: false, 6: false, 7: false, 8: false, 9: false, 10: false},
        'tra-izq': {1: false, 2: false, 3: false, 4: false, 5: false, 6: false, 7: false, 8: false, 9: false, 10: false},
        'tra-der': {1: false, 2: false, 3: false, 4: false, 5: false, 6: false, 7: false, 8: false, 9: false, 10: false}
      };
      
      mostrarExito('Formulario limpiado correctamente');
    }
  }

  // Inicializar al cargar la página
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      // Cargar datos
      await cargarDatos();
      
      // Establecer fecha actual
      setCurrentDateTime();
      
      // Poblar checklists
      poblarTodosChecklists();
      
      // Configurar cálculo de próxima mantención KM
      calcularProximaMantencionKM();
      
      // Inicializar objeto de datos
      window.checklistData = {};
      
      // Configurar eventos para los pernos
      document.querySelectorAll('.bolt').forEach(bolt => {
        bolt.addEventListener('click', function() {
          toggleBolt(this);
        });
      });
      
      // Enfocar primer campo si no es modo lectura
      if (sessionStorage.getItem('tipoUsuario') !== 'lectura') {
        document.getElementById('nombre_mecanico').focus();
      }
      
      console.log('Formulario cargado correctamente');
    } catch (error) {
      console.error('Error al inicializar:', error);
      mostrarError('Error al inicializar el formulario: ' + error.message);
    }
  });
</script>
</body>
</html>